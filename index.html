<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR„Ç≥„Éº„Éâ3√ó3„Ç∞„É™„ÉÉ„ÉâËª¢ÈÄÅ„Ç∑„Çπ„ÉÜ„É† - AzureÁâà</title>
    <!-- QR„Ç≥„Éº„ÉâÁîüÊàê„É©„Ç§„Éñ„É©„É™ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- ÂúßÁ∏Æ„É©„Ç§„Éñ„É©„É™ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <!-- QR„Ç≥„Éº„ÉâË™≠„ÅøÂèñ„Çä„É©„Ç§„Éñ„É©„É™ -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f7;
        }
        .container {
            background-color: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }
        h1 {
            color: #1d1d1f;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2rem;
        }
        .mode-selector {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
        }
        .mode-btn {
            padding: 15px 40px;
            font-size: 18px;
            border: 2px solid #007aff;
            background-color: white;
            color: #007aff;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .mode-btn.active {
            background-color: #007aff;
            color: white;
        }
        .section {
            display: none;
            margin-top: 20px;
        }
        .section.active {
            display: block;
        }
        
        /* ÈÄÅ‰ø°ÂÅ¥„Çπ„Çø„Ç§„É´ */
        .file-label {
            display: inline-block;
            padding: 14px 28px;
            background-color: #34c759;
            color: white;
            border-radius: 12px;
            cursor: pointer;
            margin-bottom: 20px;
            font-size: 16px;
            font-weight: 500;
        }
        .file-label:hover {
            background-color: #28a745;
        }
        #fileInput {
            display: none;
        }
        
        /* QR„Ç≥„Éº„Éâ„Ç∞„É™„ÉÉ„Éâ */
        #qrGridDisplay {
            text-align: center;
            margin: 20px auto;
            max-width: 900px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 400px;
        }
        
        .qr-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 15px;
            padding: 20px;
            background-color: #f5f5f7;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 900px;
            aspect-ratio: 1 / 1;
        }
        
        .qr-cell {
            background-color: white;
            border: 2px solid #e5e5e7;
            border-radius: 16px;
            padding: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            aspect-ratio: 1 / 1;
        }
        
        .qr-cell canvas {
            max-width: 100% !important;
            max-height: 100% !important;
            width: auto !important;
            height: auto !important;
        }
        
        .qr-cell-header {
            position: absolute;
            top: 8px;
            left: 8px;
            background-color: #007aff;
            color: white;
            padding: 4px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            z-index: 1;
        }
        
        /* Âèó‰ø°ÂÅ¥„Çπ„Çø„Ç§„É´ */
        #videoContainer {
            position: relative;
            max-width: 800px;
            margin: 0 auto 20px;
            border-radius: 12px;
            overflow: hidden;
            background-color: #000;
        }
        
        #video {
            width: 100%;
            height: auto;
            display: block;
        }
        
        #captureCanvas {
            display: none;
        }
        
        .capture-indicator {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 8px 16px;
            background-color: rgba(255, 59, 48, 0.9);
            color: white;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
            animation: pulse 1s infinite;
            transition: all 0.3s;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }
        
        .captured-images {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .captured-image {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            background-color: #f5f5f7;
            aspect-ratio: 1;
        }
        
        .captured-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .captured-image-number {
            position: absolute;
            top: 8px;
            left: 8px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
        }
        
        /* ÂÖ±ÈÄö„Çπ„Çø„Ç§„É´ */
        .info {
            background-color: #f5f5f7;
            padding: 20px;
            border-radius: 12px;
            margin: 15px 0;
            border-left: 4px solid #007aff;
        }
        
        .info p {
            margin: 8px 0;
            color: #1d1d1f;
        }
        
        .progress {
            width: 100%;
            height: 8px;
            background-color: #e5e5e7;
            border-radius: 4px;
            overflow: hidden;
            margin: 20px 0;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #007aff, #0051d5);
            width: 0%;
            transition: width 0.3s;
        }
        
        .control-btn {
            padding: 14px 28px;
            margin: 0 10px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .start-btn {
            background-color: #007aff;
            color: white;
        }
        
        .stop-btn {
            background-color: #ff3b30;
            color: white;
        }
        
        .process-btn {
            background-color: #34c759;
            color: white;
        }
        
        .download-btn {
            background-color: #5856d6;
            color: white;
        }
        
        .status-message {
            text-align: center;
            font-size: 18px;
            font-weight: 600;
            margin: 20px 0;
            padding: 16px;
            border-radius: 12px;
        }
        
        .status-waiting {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .status-processing {
            background-color: #cfe2ff;
            color: #084298;
        }
        
        .status-success {
            background-color: #d1e7dd;
            color: #0f5132;
        }
        
        .status-error {
            background-color: #f8d7da;
            color: #842029;
        }
        
        .settings {
            background-color: #f5f5f7;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        
        .setting-item {
            margin: 15px 0;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .setting-item label {
            flex: 1;
            font-weight: 500;
            color: #1d1d1f;
        }
        
        .setting-item input[type="number"],
        .setting-item select {
            padding: 10px;
            border: 1px solid #d1d1d6;
            border-radius: 8px;
            font-size: 16px;
            background-color: white;
        }
        
        .auto-capture-settings {
            background-color: #e3f2fd;
            border: 1px solid #90caf9;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
        }
        
        .auto-capture-settings h3 {
            color: #1976d2;
            margin-top: 0;
        }
        
        /* „É¢„Éê„Ç§„É´ÂØæÂøú */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            .mode-btn {
                padding: 12px 24px;
                font-size: 16px;
            }
            .qr-grid {
                gap: 10px;
                padding: 15px;
            }
            .captured-images {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üì± QR„Ç≥„Éº„Éâ3√ó3„Ç∞„É™„ÉÉ„ÉâËª¢ÈÄÅ„Ç∑„Çπ„ÉÜ„É†</h1>
        
        <div class="mode-selector">
            <button class="mode-btn active" onclick="setMode('send')">üì§ ÈÄÅ‰ø°„É¢„Éº„Éâ</button>
            <button class="mode-btn" onclick="setMode('receive')">üì• Âèó‰ø°„É¢„Éº„Éâ</button>
        </div>

        <!-- ÈÄÅ‰ø°„É¢„Éº„Éâ -->
        <div id="sendSection" class="section active">
            <h2>„Éï„Ç°„Ç§„É´ÈÄÅ‰ø°</h2>
            
            <div class="settings">
                <h3>‚öôÔ∏è Ëª¢ÈÄÅË®≠ÂÆö</h3>
                <div class="setting-item">
                    <label>„ÉÅ„É£„É≥„ÇØ„Çµ„Ç§„Ç∫ („Éê„Ç§„Éà):</label>
                    <input type="number" id="chunkSize" value="400" min="100" max="1000">
                </div>
                <div class="setting-item">
                    <label>Âàá„ÇäÊõø„ÅàÈÄüÂ∫¶:</label>
                    <select id="sendSpeed">
                        <option value="5000">„ÇÜ„Å£„Åè„Çä (5Áßí)</option>
                        <option value="3000" selected>Ê®ôÊ∫ñ (3Áßí)</option>
                        <option value="2000">È´òÈÄü (2Áßí)</option>
                        <option value="1000">Ë∂ÖÈ´òÈÄü (1Áßí)</option>
                    </select>
                </div>
                <div class="setting-item">
                    <label>„Éá„Éº„ÇøÂúßÁ∏Æ„Çí‰ΩøÁî®:</label>
                    <input type="checkbox" id="useCompression" checked>
                </div>
            </div>

            <label for="fileInput" class="file-label">üìÅ „Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû</label>
            <input type="file" id="fileInput" accept="*/*">
            
            <div id="fileInfo" class="info" style="display:none;">
                <p><strong>üìÑ „Éï„Ç°„Ç§„É´Âêç:</strong> <span id="fileName"></span></p>
                <p><strong>üìä „Çµ„Ç§„Ç∫:</strong> <span id="fileSize"></span></p>
                <p><strong>üî¢ Á∑è„ÉÅ„É£„É≥„ÇØÊï∞:</strong> <span id="chunkCount"></span></p>
                <p><strong>üì¶ Á∑è„Éö„Éº„Ç∏Êï∞:</strong> <span id="totalPages"></span></p>
            </div>

            <div style="text-align: center; margin: 20px 0;">
                <button class="control-btn start-btn" onclick="startTransmission()" style="display:none;">‚ñ∂Ô∏è ÈÄÅ‰ø°ÈñãÂßã</button>
                <button class="control-btn stop-btn" onclick="stopTransmission()" style="display:none;">‚èπÔ∏è ÈÄÅ‰ø°ÂÅúÊ≠¢</button>
            </div>

            <div id="sendStatus" class="status-message status-waiting" style="display:none;">
                Ê∫ñÂÇôÂÆå‰∫Ü - ÈÄÅ‰ø°ÈñãÂßã„ÇíÊäº„Åó„Å¶„Åè„Å†„Åï„ÅÑ
            </div>

            <div id="qrGridDisplay">
                <div class="qr-grid" id="qrGrid"></div>
            </div>

            <div class="progress" style="display:none;">
                <div class="progress-bar" id="sendProgress"></div>
            </div>

            <div class="info" id="pageInfo" style="display:none;">
                <p><strong>üìÑ ÁèæÂú®„ÅÆ„Éö„Éº„Ç∏:</strong> <span id="currentPage">0</span> / <span id="totalPagesDisplay">0</span></p>
                <p><strong>üîÑ „Çµ„Ç§„ÇØ„É´Êï∞:</strong> <span id="cycleCount">0</span></p>
            </div>
        </div>

        <!-- Âèó‰ø°„É¢„Éº„Éâ -->
        <div id="receiveSection" class="section">
            <h2>„Éï„Ç°„Ç§„É´Âèó‰ø°</h2>
            
            <div class="auto-capture-settings">
                <h3>üì∏ Ëá™ÂãïÊíÆÂΩ±Ë®≠ÂÆö</h3>
                <div class="setting-item">
                    <label>QRÂ§âÂåñÊ§úÁü•Âæå„ÅÆÂæÖÊ©üÊôÇÈñì („Éü„É™Áßí):</label>
                    <input type="number" id="captureDelay" value="300" min="100" max="1000" step="100">
                </div>
                <div class="setting-item">
                    <label>ÊúÄÂ§ßÊíÆÂΩ±ÊûöÊï∞:</label>
                    <input type="number" id="maxCaptures" value="30" min="5" max="50">
                </div>
            </div>
            
            <div class="info">
                <p>üìπ „Ç´„É°„É©„ÅßÈÄÅ‰ø°ÂÅ¥„ÅÆÁîªÈù¢„ÇíÊò†„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
                <p>üéØ Â∑¶‰∏ä„ÅÆQR„Ç≥„Éº„Éâ„ÅåÂ§â„Çè„Çã„Å®Ëá™ÂãïÁöÑ„Å´ÊíÆÂΩ±„Åó„Åæ„Åô</p>
                <p>‚úã „Åô„Åπ„Å¶„ÅÆ„Éö„Éº„Ç∏„ÇíÊíÆÂΩ±„Åó„Åü„Çâ„ÄåÊíÆÂΩ±ÂÅúÊ≠¢„Äç„ÇíÊäº„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
            </div>

            <div style="text-align: center; margin: 20px 0;">
                <button class="control-btn start-btn" onclick="startAutoCapture()">
                    üé¨ Ëá™ÂãïÊíÆÂΩ±ÈñãÂßã
                </button>
                <button class="control-btn stop-btn" onclick="stopAutoCapture()" style="display:none;">
                    ‚èπÔ∏è ÊíÆÂΩ±ÂÅúÊ≠¢
                </button>
                <button class="control-btn process-btn" onclick="processImages()" id="processBtn" style="display:none;">
                    üîç Ëß£ÊûêÈñãÂßã
                </button>
                <button class="control-btn download-btn" onclick="downloadFile()" id="downloadBtn" style="display:none;">
                    üíæ „ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
                </button>
            </div>

            <div id="captureStatus" class="status-message status-waiting" style="display:none;">
                „Ç´„É°„É©„ÇíÊ∫ñÂÇô‰∏≠...
            </div>

            <div id="videoContainer" style="display:none;">
                <video id="video" autoplay playsinline></video>
                <canvas id="captureCanvas"></canvas>
                <div class="capture-indicator" id="captureIndicator" style="display:none;">
                    üî¥ REC
                </div>
            </div>

            <div class="captured-images" id="capturedImages"></div>

            <div class="progress" id="processProgress" style="display:none;">
                <div class="progress-bar" id="processProgressBar"></div>
            </div>

            <div id="receiveInfo" class="info" style="display:none;">
                <p><strong>üìÑ „Éï„Ç°„Ç§„É´Âêç:</strong> <span id="receivedFileName">-</span></p>
                <p><strong>üî¢ Âèó‰ø°„ÉÅ„É£„É≥„ÇØ:</strong> <span id="receivedChunks">0</span> / <span id="totalChunks">-</span></p>
                <p><strong>üì∏ ÊíÆÂΩ±ÊûöÊï∞:</strong> <span id="capturedCount">0</span></p>
                <p><strong>‚úÖ Âá¶ÁêÜÊ∏à„ÅøÁîªÂÉè:</strong> <span id="processedImages">0</span></p>
            </div>
        </div>
    </div>

    <script>
        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
        let currentMode = 'send';
        let fileData = null;
        let chunks = [];
        let currentPage = 0;
        let transmissionInterval = null;
        let cycleCount = 0;
        
        // Âèó‰ø°ÂÅ¥Â§âÊï∞
        let capturedImages = [];
        let receivedChunksData = {};
        let totalChunksCount = 0;
        let receivedFileInfo = null;
        let videoStream = null;
        let isMonitoring = false;
        let lastQRContent = null;
        let monitoringIntervalId = null;
        
        // AzureË®≠ÂÆöÔºà„ÉÜ„Çπ„ÉàÁî®Ôºâ
        const AZURE_ENDPOINT = 'https://azure-document-intelligence-2.cognitiveservices.azure.com/';
        const AZURE_KEY = '7jg4O09qKLNJjCp7MKoXgR7PuEYR8j9yF9AM1VAhAiMXiHLwhkXhJQQJ99BFACYeBjFXJ3w3AAALACOG9ljp';
        
        // ÂàùÊúüÂåñ
        window.addEventListener('DOMContentLoaded', () => {
            initQRGrid();
        });

        // „É¢„Éº„ÉâÂàáÊõø
        function setMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
            
            if (mode === 'send') {
                document.querySelector('.mode-btn:first-child').classList.add('active');
                document.getElementById('sendSection').classList.add('active');
                stopAutoCapture();
            } else {
                document.querySelector('.mode-btn:last-child').classList.add('active');
                document.getElementById('receiveSection').classList.add('active');
                stopTransmission();
            }
        }

        // QR„Ç∞„É™„ÉÉ„ÉâÂàùÊúüÂåñ
        function initQRGrid() {
            const grid = document.getElementById('qrGrid');
            grid.innerHTML = '';
            for (let i = 0; i < 9; i++) {
                const cell = document.createElement('div');
                cell.className = 'qr-cell';
                cell.id = `qr-cell-${i}`;
                grid.appendChild(cell);
            }
        }

        // „Éï„Ç°„Ç§„É´ÈÅ∏ÊäûÂá¶ÁêÜ
        document.getElementById('fileInput').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;

            document.getElementById('fileInfo').style.display = 'block';
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = formatFileSize(file.size);
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                const arrayBuffer = e.target.result;
                const uint8Array = new Uint8Array(arrayBuffer);
                
                const useCompression = document.getElementById('useCompression').checked;
                let processedData;
                
                if (useCompression) {
                    processedData = pako.deflate(uint8Array);
                } else {
                    processedData = uint8Array;
                }
                
                const base64Data = arrayBufferToBase64(processedData);
                
                fileData = {
                    name: file.name,
                    type: file.type,
                    data: base64Data,
                    compressed: useCompression
                };
                
                const chunkSize = parseInt(document.getElementById('chunkSize').value);
                chunks = [];
                for (let i = 0; i < fileData.data.length; i += chunkSize) {
                    chunks.push(fileData.data.substr(i, chunkSize));
                }
                
                const totalPages = Math.ceil((chunks.length + 1) / 9);
                
                document.getElementById('chunkCount').textContent = chunks.length;
                document.getElementById('totalPages').textContent = totalPages;
                document.getElementById('sendStatus').style.display = 'block';
                document.querySelector('.start-btn').style.display = 'inline-block';
                
                displayInitialPage();
            };
            
            reader.readAsArrayBuffer(file);
        });

        // Base64„Ç®„É≥„Ç≥„Éº„Éâ
        function arrayBufferToBase64(buffer) {
            let binary = '';
            const bytes = new Uint8Array(buffer);
            const chunkSize = 0x8000;
            
            for (let i = 0; i < bytes.length; i += chunkSize) {
                const chunk = bytes.subarray(i, i + chunkSize);
                binary += String.fromCharCode.apply(null, chunk);
            }
            
            return btoa(binary);
        }

        // „Éï„Ç°„Ç§„É´„Çµ„Ç§„Ç∫„Éï„Ç©„Éº„Éû„ÉÉ„Éà
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            else if (bytes < 1048576) return Math.round(bytes / 1024) + ' KB';
            else return Math.round(bytes / 1048576 * 10) / 10 + ' MB';
        }

        // ÂàùÊúü„Éö„Éº„Ç∏Ë°®Á§∫
        function displayInitialPage() {
            const headerData = JSON.stringify({
                type: 'header',
                fileName: fileData.name,
                fileType: fileData.type,
                compressed: fileData.compressed,
                totalChunks: chunks.length
            });
            
            const cell = document.getElementById('qr-cell-0');
            cell.innerHTML = '';
            
            const header = document.createElement('div');
            header.className = 'qr-cell-header';
            header.textContent = 'HEADER';
            cell.appendChild(header);
            
            const qrDiv = document.createElement('div');
            cell.appendChild(qrDiv);
            
            new QRCode(qrDiv, {
                text: headerData,
                width: 200,
                height: 200,
                correctLevel: QRCode.CorrectLevel.M
            });
            
            for (let i = 1; i < 9; i++) {
                document.getElementById(`qr-cell-${i}`).innerHTML = '';
            }
        }

        // ÈÄÅ‰ø°ÈñãÂßã
        function startTransmission() {
            if (!fileData) return;
            
            currentPage = 0;
            cycleCount = 0;
            document.querySelector('.start-btn').style.display = 'none';
            document.querySelector('.stop-btn').style.display = 'inline-block';
            document.querySelector('.progress').style.display = 'block';
            document.getElementById('pageInfo').style.display = 'block';
            document.getElementById('sendStatus').textContent = 'üì° ÈÄÅ‰ø°‰∏≠...';
            document.getElementById('sendStatus').className = 'status-message status-processing';
            
            displayPage(currentPage);
            
            const sendSpeed = parseInt(document.getElementById('sendSpeed').value);
            transmissionInterval = setInterval(() => {
                currentPage++;
                const totalPages = Math.ceil((chunks.length + 1) / 9);
                
                if (currentPage >= totalPages) {
                    currentPage = 0;
                    cycleCount++;
                    document.getElementById('cycleCount').textContent = cycleCount;
                }
                
                displayPage(currentPage);
            }, sendSpeed);
        }

        // ÈÄÅ‰ø°ÂÅúÊ≠¢
        function stopTransmission() {
            if (transmissionInterval) {
                clearInterval(transmissionInterval);
                transmissionInterval = null;
            }
            document.querySelector('.start-btn').style.display = 'inline-block';
            document.querySelector('.stop-btn').style.display = 'none';
            document.getElementById('sendStatus').textContent = '‚è∏Ô∏è ÈÄÅ‰ø°ÂÅúÊ≠¢';
            document.getElementById('sendStatus').className = 'status-message status-waiting';
        }

        // „Éö„Éº„Ç∏Ë°®Á§∫
        function displayPage(pageIndex) {
            const totalPages = Math.ceil((chunks.length + 1) / 9);
            document.getElementById('currentPage').textContent = pageIndex + 1;
            document.getElementById('totalPagesDisplay').textContent = totalPages;
            
            const startIndex = pageIndex * 9 - 1;
            
            for (let i = 0; i < 9; i++) {
                const cell = document.getElementById(`qr-cell-${i}`);
                cell.innerHTML = '';
                
                const chunkIndex = startIndex + i;
                
                if (pageIndex === 0 && i === 0) {
                    // „Éò„ÉÉ„ÉÄ„Éº
                    const header = document.createElement('div');
                    header.className = 'qr-cell-header';
                    header.textContent = 'HEADER';
                    cell.appendChild(header);
                    
                    const qrDiv = document.createElement('div');
                    cell.appendChild(qrDiv);
                    
                    const headerData = JSON.stringify({
                        type: 'header',
                        fileName: fileData.name,
                        fileType: fileData.type,
                        compressed: fileData.compressed,
                        totalChunks: chunks.length
                    });
                    
                    new QRCode(qrDiv, {
                        text: headerData,
                        width: 200,
                        height: 200,
                        correctLevel: QRCode.CorrectLevel.M
                    });
                } else if (chunkIndex >= 0 && chunkIndex < chunks.length) {
                    // „Éá„Éº„Çø„ÉÅ„É£„É≥„ÇØ
                    const header = document.createElement('div');
                    header.className = 'qr-cell-header';
                    header.textContent = `#${chunkIndex + 1}`;
                    cell.appendChild(header);
                    
                    const qrDiv = document.createElement('div');
                    cell.appendChild(qrDiv);
                    
                    const chunkData = JSON.stringify({
                        type: 'chunk',
                        chunkIndex: chunkIndex,
                        data: chunks[chunkIndex]
                    });
                    
                    new QRCode(qrDiv, {
                        text: chunkData,
                        width: 200,
                        height: 200,
                        correctLevel: QRCode.CorrectLevel.M
                    });
                }
            }
            
            // ÈÄ≤ÊçóÊõ¥Êñ∞
            const progress = Math.round((pageIndex + 1) / totalPages * 100);
            document.getElementById('sendProgress').style.width = progress + '%';
        }

        // Ëá™ÂãïÊíÆÂΩ±ÈñãÂßã
        async function startAutoCapture() {
            capturedImages = [];
            updateCapturedImagesDisplay();
            lastQRContent = null;
            
            document.getElementById('captureStatus').style.display = 'block';
            document.getElementById('captureStatus').textContent = 'üìπ „Ç´„É°„É©„ÇíËµ∑Âãï‰∏≠...';
            document.getElementById('captureStatus').className = 'status-message status-processing';
            document.getElementById('videoContainer').style.display = 'block';
            document.querySelector('#receiveSection .start-btn').style.display = 'none';
            document.querySelector('#receiveSection .stop-btn').style.display = 'inline-block';
            
            const video = document.getElementById('video');
            const canvas = document.getElementById('captureCanvas');
            
            try {
                // „Ç´„É°„É©„ÇíËµ∑Âãï
                videoStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    }
                });
                
                video.srcObject = videoStream;
                await video.play();
                
                // „Éì„Éá„Ç™„ÅÆÊ∫ñÂÇô„Åå„Åß„Åç„Åü„ÇâÁõ£Ë¶ñÈñãÂßã
                video.onloadedmetadata = () => {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    isMonitoring = true;
                    document.getElementById('captureIndicator').style.display = 'block';
                    document.getElementById('captureIndicator').textContent = 'üëÄ Áõ£Ë¶ñ‰∏≠';
                    document.getElementById('captureStatus').textContent = 'üëÄ Â∑¶‰∏ä„ÅÆQR„Ç≥„Éº„Éâ„ÇíÁõ£Ë¶ñ‰∏≠...';
                    
                    // Áõ£Ë¶ñ„ÇíÈñãÂßãÔºà100ms„Åî„Å®„Å´„ÉÅ„Çß„ÉÉ„ÇØÔºâ
                    monitoringIntervalId = setInterval(monitorQRChange, 100);
                };
                
            } catch (error) {
                console.error('„Ç´„É°„É©„Ç®„É©„Éº:', error);
                document.getElementById('captureStatus').textContent = '‚ùå „Ç´„É°„É©„ÅÆËµ∑Âãï„Å´Â§±Êïó„Åó„Åæ„Åó„Åü';
                document.getElementById('captureStatus').className = 'status-message status-error';
                stopAutoCapture();
            }
        }

        // QR„Ç≥„Éº„Éâ„ÅÆÂ§âÂåñ„ÇíÁõ£Ë¶ñ
        function monitorQRChange() {
            if (!isMonitoring) return;
            
            const video = document.getElementById('video');
            const canvas = document.getElementById('captureCanvas');
            const ctx = canvas.getContext('2d');
            
            // „Éì„Éá„Ç™„Éï„É¨„Éº„É†„Çí„Ç≠„É£„É≥„Éê„Çπ„Å´ÊèèÁîª
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Â∑¶‰∏ä„ÅÆQR„Ç≥„Éº„Éâ„Ç®„É™„Ç¢„ÇíÊäΩÂá∫ÔºàÁîªÈù¢„ÅÆ1/3„Çµ„Ç§„Ç∫Ôºâ
            const cellWidth = canvas.width / 3;
            const cellHeight = canvas.height / 3;
            
            try {
                // Â∑¶‰∏ä„Çª„É´„ÅÆÁîªÂÉè„Éá„Éº„Çø„ÇíÂèñÂæó
                const imageData = ctx.getImageData(0, 0, cellWidth, cellHeight);
                
                // jsQR„ÅßQR„Ç≥„Éº„Éâ„ÇíË™≠„ÅøÂèñ„Çä
                const code = jsQR(imageData.data, cellWidth, cellHeight);
                
                if (code && code.data) {
                    // QR„Ç≥„Éº„Éâ„ÅÆÂÜÖÂÆπ„ÅåÂ§â„Çè„Å£„Åü„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                    if (lastQRContent !== code.data) {
                        console.log('QR„Ç≥„Éº„ÉâÂ§âÂåñÊ§úÁü•:', code.data.substring(0, 50) + '...');
                        lastQRContent = code.data;
                        
                        // Â§âÂåñÊ§úÁü•Âæå„ÅÆÂæÖÊ©üÊôÇÈñì
                        const delay = parseInt(document.getElementById('captureDelay').value);
                        
                        setTimeout(() => {
                            const maxCaptures = parseInt(document.getElementById('maxCaptures').value);
                            if (capturedImages.length < maxCaptures) {
                                captureImage();
                                document.getElementById('captureStatus').textContent = `üì∏ QRÂ§âÂåñ„ÇíÊ§úÁü•ÔºÅÊíÆÂΩ± (${capturedImages.length + 1}/${maxCaptures}Êûö)`;
                            } else {
                                stopAutoCapture();
                            }
                        }, delay);
                    }
                }
            } catch (e) {
                // QR„Ç≥„Éº„ÉâË™≠„ÅøÂèñ„Çä„Ç®„É©„Éº„ÅØÁÑ°Ë¶ñ
            }
        }

        // ÊíÆÂΩ±ÂÆüË°å
        function captureImage() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('captureCanvas');
            const ctx = canvas.getContext('2d');
            
            // „Éì„Éá„Ç™„ÅÆ„Çµ„Ç§„Ç∫„Å´Âêà„Çè„Åõ„Å¶„Ç≠„É£„É≥„Éê„Çπ„ÇíË®≠ÂÆö
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // „Éì„Éá„Ç™„Éï„É¨„Éº„É†„Çí„Ç≠„É£„É≥„Éê„Çπ„Å´ÊèèÁîª
            ctx.drawImage(video, 0, 0);
            
            // „Ç≠„É£„É≥„Éê„Çπ„Åã„ÇâBlob„ÇíÁîüÊàê
            canvas.toBlob((blob) => {
                capturedImages.push(blob);
                updateCapturedImagesDisplay();
                document.getElementById('capturedCount').textContent = capturedImages.length;
                
                // ÊíÆÂΩ±„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº„Çí„Éï„É©„ÉÉ„Ç∑„É•
                const indicator = document.getElementById('captureIndicator');
                indicator.textContent = 'üì∏ ÊíÆÂΩ±ÔºÅ';
                indicator.style.backgroundColor = '#34c759';
                setTimeout(() => {
                    indicator.textContent = 'üëÄ Áõ£Ë¶ñ‰∏≠';
                    indicator.style.backgroundColor = 'rgba(255, 59, 48, 0.9)';
                }, 300);
            }, 'image/jpeg', 0.9);
        }

        // Ëá™ÂãïÊíÆÂΩ±ÂÅúÊ≠¢
        function stopAutoCapture() {
            isMonitoring = false;
            
            if (monitoringIntervalId) {
                clearInterval(monitoringIntervalId);
                monitoringIntervalId = null;
            }
            
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
            
            document.getElementById('video').srcObject = null;
            document.getElementById('videoContainer').style.display = 'none';
            document.getElementById('captureIndicator').style.display = 'none';
            document.querySelector('#receiveSection .start-btn').style.display = 'inline-block';
            document.querySelector('#receiveSection .stop-btn').style.display = 'none';
            
            if (capturedImages.length > 0) {
                document.getElementById('processBtn').style.display = 'inline-block';
                document.getElementById('captureStatus').textContent = `‚úÖ ${capturedImages.length}Êûö„ÅÆÂÜôÁúü„ÇíÊíÆÂΩ±„Åó„Åæ„Åó„Åü`;
                document.getElementById('captureStatus').className = 'status-message status-success';
            }
        }

        // „Ç≠„É£„Éó„ÉÅ„É£ÁîªÂÉèË°®Á§∫Êõ¥Êñ∞
        function updateCapturedImagesDisplay() {
            const container = document.getElementById('capturedImages');
            container.innerHTML = '';
            
            capturedImages.forEach((blob, index) => {
                const div = document.createElement('div');
                div.className = 'captured-image';
                
                const img = document.createElement('img');
                img.src = URL.createObjectURL(blob);
                div.appendChild(img);
                
                const number = document.createElement('div');
                number.className = 'captured-image-number';
                number.textContent = `#${index + 1}`;
                div.appendChild(number);
                
                container.appendChild(div);
            });
        }

        // ÁîªÂÉè„Çí„É™„Çµ„Ç§„Ç∫
        async function resizeImage(blob) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // Èï∑Ëæ∫„Çí1600px„Å´Âà∂Èôê
                    const maxSize = 1600;
                    let width = img.width;
                    let height = img.height;
                    
                    if (width > height && width > maxSize) {
                        height = (height * maxSize) / width;
                        width = maxSize;
                    } else if (height > maxSize) {
                        width = (width * maxSize) / height;
                        height = maxSize;
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    canvas.toBlob((resizedBlob) => {
                        resolve(resizedBlob);
                    }, 'image/jpeg', 0.9);
                };
                
                img.src = URL.createObjectURL(blob);
            });
        }

        // ÁîªÂÉèËß£ÊûêÂá¶ÁêÜ
        async function processImages() {
            if (capturedImages.length === 0) {
                alert('ÁîªÂÉè„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                return;
            }
            
            document.getElementById('processBtn').disabled = true;
            document.getElementById('captureStatus').textContent = 'üîÑ ÁîªÂÉè„ÇíËß£Êûê‰∏≠...';
            document.getElementById('captureStatus').className = 'status-message status-processing';
            document.getElementById('processProgress').style.display = 'block';
            document.getElementById('receiveInfo').style.display = 'block';
            
            receivedChunksData = {};
            receivedFileInfo = null;
            totalChunksCount = 0;
            
            document.getElementById('processedImages').textContent = '0';
            
            for (let i = 0; i < capturedImages.length; i++) {
                document.getElementById('processedImages').textContent = i + 1;
                const progress = Math.round(((i + 1) / capturedImages.length) * 100);
                document.getElementById('processProgressBar').style.width = progress + '%';
                
                try {
                    // ÁîªÂÉè„Çí„É™„Çµ„Ç§„Ç∫
                    const resizedBlob = await resizeImage(capturedImages[i]);
                    
                    // Azure API„ÇíÂëº„Å≥Âá∫„Åó
                    const results = await analyzeImageWithAzure(resizedBlob);
                    
                    // ÁµêÊûú„ÇíÂá¶ÁêÜ
                    processAnalysisResults(results);
                    
                } catch (error) {
                    console.error(`ÁîªÂÉè ${i + 1} „ÅÆËß£Êûê„Ç®„É©„Éº:`, error);
                }
            }
            
            // ÂÆå‰∫Ü„ÉÅ„Çß„ÉÉ„ÇØ
            const receivedCount = Object.keys(receivedChunksData).length;
            if (receivedFileInfo && receivedCount === totalChunksCount) {
                document.getElementById('captureStatus').textContent = '‚úÖ „Åô„Åπ„Å¶„ÅÆ„Éá„Éº„Çø„ÇíÂèó‰ø°„Åó„Åæ„Åó„ÅüÔºÅ';
                document.getElementById('captureStatus').className = 'status-message status-success';
                document.getElementById('downloadBtn').style.display = 'inline-block';
            } else {
                const missing = [];
                for (let i = 0; i < totalChunksCount; i++) {
                    if (!receivedChunksData.hasOwnProperty(i)) {
                        missing.push(i + 1);
                    }
                }
                document.getElementById('captureStatus').textContent = `‚ö†Ô∏è ‰∏çË∂≥„ÉÅ„É£„É≥„ÇØ: ${missing.join(', ')}`;
                document.getElementById('captureStatus').className = 'status-message status-error';
            }
            
            document.getElementById('processBtn').disabled = false;
        }

        // Azure Document Intelligence APIÂëº„Å≥Âá∫„Åó
        async function analyzeImageWithAzure(imageBlob) {
            const analyzeUrl = `${AZURE_ENDPOINT}documentintelligence/documentModels/prebuilt-read:analyze?api-version=2024-11-30&features=barcodes`;
            
            // ÁîªÂÉè„Çí„Éê„Ç§„Éä„É™„Å®„Åó„Å¶Ë™≠„ÅøËæº„Åø
            const arrayBuffer = await imageBlob.arrayBuffer();
            
            // Ëß£Êûê„É™„ÇØ„Ç®„Çπ„Éà
            const response = await fetch(analyzeUrl, {
                method: 'POST',
                headers: {
                    'Ocp-Apim-Subscription-Key': AZURE_KEY,
                    'Content-Type': 'application/octet-stream'
                },
                body: arrayBuffer
            });
            
            if (!response.ok) {
                throw new Error(`Azure API „Ç®„É©„Éº: ${response.status}`);
            }
            
            // Operation-Location„Éò„ÉÉ„ÉÄ„Éº„Åã„ÇâÁµêÊûúURL„ÇíÂèñÂæó
            const operationLocation = response.headers.get('Operation-Location');
            if (!operationLocation) {
                throw new Error('Operation-Location „Éò„ÉÉ„ÉÄ„Éº„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
            }
            
            // „Éù„Éº„É™„É≥„Ç∞„Åó„Å¶ÁµêÊûú„ÇíÂèñÂæó
            return await pollForResults(operationLocation);
        }

        // ÁµêÊûú„ÅÆ„Éù„Éº„É™„É≥„Ç∞
        async function pollForResults(operationUrl) {
            const maxAttempts = 60;
            const delay = 1000;
            
            for (let i = 0; i < maxAttempts; i++) {
                const response = await fetch(operationUrl, {
                    headers: {
                        'Ocp-Apim-Subscription-Key': AZURE_KEY
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`„Éù„Éº„É™„É≥„Ç∞„Ç®„É©„Éº: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.status === 'succeeded') {
                    return result.analyzeResult;
                } else if (result.status === 'failed') {
                    throw new Error('Ëß£Êûê„ÅåÂ§±Êïó„Åó„Åæ„Åó„Åü');
                }
                
                // „Åæ„Å†Âá¶ÁêÜ‰∏≠„ÅÆÂ†¥Âêà„ÅØÂæÖÊ©ü
                await new Promise(resolve => setTimeout(resolve, delay));
            }
            
            throw new Error('„Çø„Ç§„É†„Ç¢„Ç¶„Éà: Ëß£Êûê„ÅåÂÆå‰∫Ü„Åó„Åæ„Åõ„Çì„Åß„Åó„Åü');
        }

        // Ëß£ÊûêÁµêÊûú„ÅÆÂá¶ÁêÜ
        function processAnalysisResults(analyzeResult) {
            if (!analyzeResult.pages) return;
            
            analyzeResult.pages.forEach(page => {
                if (page.barcodes) {
                    page.barcodes.forEach(barcode => {
                        try {
                            const data = JSON.parse(barcode.value);
                            
                            if (data.type === 'header') {
                                // „Éò„ÉÉ„ÉÄ„ÉºÊÉÖÂ†±„Çí‰øùÂ≠ò
                                receivedFileInfo = {
                                    fileName: data.fileName,
                                    fileType: data.fileType,
                                    compressed: data.compressed
                                };
                                totalChunksCount = data.totalChunks;
                                
                                document.getElementById('receivedFileName').textContent = data.fileName;
                                document.getElementById('totalChunks').textContent = totalChunksCount;
                                
                            } else if (data.type === 'chunk') {
                                // „ÉÅ„É£„É≥„ÇØ„Éá„Éº„Çø„Çí‰øùÂ≠ò
                                if (!receivedChunksData.hasOwnProperty(data.chunkIndex)) {
                                    receivedChunksData[data.chunkIndex] = data.data;
                                    document.getElementById('receivedChunks').textContent = Object.keys(receivedChunksData).length;
                                }
                            }
                        } catch (e) {
                            // JSONËß£Êûê„Ç®„É©„Éº„ÅØÁÑ°Ë¶ñ
                        }
                    });
                }
            });
        }

        // „Éï„Ç°„Ç§„É´„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
        function downloadFile() {
            if (!receivedFileInfo || Object.keys(receivedChunksData).length !== totalChunksCount) {
                alert('„Éï„Ç°„Ç§„É´„ÅÆÂèó‰ø°„ÅåÂÆå‰∫Ü„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì');
                return;
            }
            
            try {
                // „ÉÅ„É£„É≥„ÇØ„ÇíÁµêÂêà
                let completeData = '';
                for (let i = 0; i < totalChunksCount; i++) {
                    completeData += receivedChunksData[i];
                }
                
                // Base64„Éá„Ç≥„Éº„Éâ
                const binaryString = atob(completeData);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                
                // ÂúßÁ∏ÆËß£Èô§
                let finalData = bytes;
                if (receivedFileInfo.compressed) {
                    finalData = pako.inflate(bytes);
                }
                
                // „ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
                const blob = new Blob([finalData], { type: receivedFileInfo.fileType });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = receivedFileInfo.fileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                // „É™„Çª„ÉÉ„Éà
                capturedImages = [];
                updateCapturedImagesDisplay();
                receivedChunksData = {};
                receivedFileInfo = null;
                totalChunksCount = 0;
                document.getElementById('downloadBtn').style.display = 'none';
                document.getElementById('processBtn').style.display = 'none';
                document.getElementById('receiveInfo').style.display = 'none';
                document.getElementById('processProgress').style.display = 'none';
                document.getElementById('captureStatus').style.display = 'none';
                
            } catch (error) {
                alert('„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Ç®„É©„Éº: ' + error.message);
            }
        }
    </script>
</body>
</html>
